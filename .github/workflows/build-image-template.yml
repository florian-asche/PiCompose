name: Build PiCompose (Template)

on:
  workflow_call:
    inputs:
      image-name:
        required: true
        type: string
        description: "Final image name"
      stage-list:
        required: true
        type: string
        description: "Comma or whitespace separated list of stages to execute"
      compression:
        required: false
        type: string
        default: "xz"
        description: "Compression to apply on final image (none, zip, xz, gz)"
      compression-level:
        required: false
        type: string
        default: "6"
        description: "Compression level 0-9"
      custom-hostname:
        required: false
        type: string
        default: "picompose"
        description: "Host name of the image"
      enable-rpi-imager-snippet:
        required: false
        type: boolean
        default: false
        description: "Enable rpi-imager.json snippet generation"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Restore package cache
        uses: actions/cache@v4
        with:
          # Unpacking directly into /var/cache would result in permission errors
          # so we need to work around this a bit.
          path: apt-cache/
          key: ${{ runner.os }}-${{ github.job }}-${{ inputs.image-name }}
          restore-keys: |
            ${{ runner.os }}-${{ github.job }}
            ${{ runner.os }}

      # Generate Raspberry Pi Imager JSON (conditional)
      - name: Generate Raspberry Pi Imager JSON
        if: inputs.enable-rpi-imager-snippet == true
        run: |
          chmod +x scripts/generate-imager-json.py
          python3 scripts/generate-imager-json.py

      - name: Delete existing RPI Imager JSON release
        if: inputs.enable-rpi-imager-snippet == true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              const release = releases.find(r => r.tag_name === 'rpi-imager-json');
              if (release) {
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
                console.log('Deleted existing release rpi-imager-json');
              }
            } catch (error) {
              console.log('Release rpi-imager-json does not exist or could not be deleted');
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete existing RPI Imager JSON tag
        if: inputs.enable-rpi-imager-snippet == true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'tags/rpi-imager-json'
              });
              console.log('Deleted existing tag rpi-imager-json');
            } catch (error) {
              console.log('Tag rpi-imager-json does not exist or could not be deleted');
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release for RPI Imager JSON
        if: inputs.enable-rpi-imager-snippet == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: rpi-imager-json
          generate_release_notes: false
          name: RPI Imager JSON
          body: 'Auto-generated Raspberry Pi Imager JSON file'
          draft: false
          prerelease: true
          files: ./rpi-imager.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
